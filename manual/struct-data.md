# Структура данных

Существует множество методологий, для организации структуры данных.
В данном разделе представлен подход основанный на [DDD](https://ru.wikipedia.org/wiki/Проблемно-ориентированное_проектирование) и [CQRS](https://ru.wikipedia.org/wiki/CQRS).

## Приложение - это слойка

Рисунок ниже демонстрирует порядок доступа к данным:
![image](https://github.com/irpsv/bitrix-docs/blob/master/manual/assets/Screenshot_2.png)

Слои:
- **application** - слой приложения, все запросы из-вне идут именно к нему;
- **domain** - слой бизнес-логики, содержит все сущности с которым работает сайт;
- **data** - слой данных, содежит сущности непосредственной самой системы хранения данных (например, таблиц если данные хранятся в СУБД);

Каждый слой, может обращаться только к соседу и только слева-направо:
- application -> domain
- domain -> data

Все сущности слоя, могут обращаться друг к другу (например, сервис может вызывать другой сервис).

Сущности слоя приложения:
- **Page** - страница сайта
- **Service** - веб-сервис

Сущности слоя домена:
- **Repository** - используется для получения и сохранения из слоя данных сущностей бизнес-логики. Отвечает только за сохранение модели, без дополнительной логики.
- **Model** - сущность бизнес логики, содержит в себе все поля представляемой сущности, а также связь с другими сущностями
- **Command** - сохранение/модификация/иные действия с моделью/моделями, которые не вписываются в репозиторий.
- **Query** - получение модели с использованием сложной логики, предварительной модификацией или тяжелые запросы к слою данных.

Сущности слоя данных:
- **DataMapper** - используется для получения сущности данных (Row)
- **Row** - сущность данных (например, если данные хранятся в СУБД, то это строка таблицы)
- **Database** - непосредственно адаптер для базы данных, через который происходят все запросы к данным

## Натягиваемся на Битрикс

Если применять данную схему для Битрикса, то в нем уже заложен инструметарий работы со слоем данных.  
Слой приложения - персонален для каждого сайта, а слой домена - это то, что по сути необходимо реализовать при создании модуля или компнента.

## Модули

Описанная структура, должна быть четко разделена по контекстам (например контекст "каталог", "корзина", ...).
Каждый контекст - это отдельный модуль.
Модуль - это самодостаточная логическая единица, которая должна основываться только на основном функционале Битрикс.
Каждый модуль, ничего не знает о других модулях.
Все зависимости строются только на интерфейсах, т.е. каждый модуль описывает необходимые для него интерфейсы, а реализации будут подставляться уже при сборке приложения.

Допустим, имеем следующий модули:
- модуль "Каталог"
- модуль "Простой каталог"
- модуль "Корзина"

Модуль "Корзина" содержит интерфейс `товары`.
Модули "Каталог" и "Простой каталог" содержат реализации товаров, но со своей логикой.
Чтобы связать модули и они могли функционировать независимо друг от друга, каждый из них, должен реализовать необходимые интерфейсы.
Собственно реализации этих интерфейсов, должны содержаться в промежуточных модулях:

![модули](https://github.com/irpsv/bitrix-docs/blob/master/manual/assets/Screenshot_1.png)

Указывать прямую зависимость одного модуля от друго **не стоит**, т.к. модули станут **не расширяемы**.
Исключением являются расширения (аддоны), которые расширяют функционал конкретного модуля.

Допустим имеем модуль "Валюты", который отвечает за реализацию цен с разными валютами.
Аддоном для данного модуля может служить модуль "Обновление курса валют", который будет периодически обновлять курс валют.
Данный модуль, не может существовать без модуля "Валют", поэтому **может** иметь прямые зависимости с ним.
