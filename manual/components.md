# Компоненты

Компоненты - это виджеты, объекты, которые на вход получают какие-либо данные и должны произвести какой-нибудь вывод.
В Битрикс компоненты делятся на 2 вида:
- простые
- комплексные

Комплексные компоненты - это по сути простые роутеры, которые подключают разные файлы в зависимости от URL.
Дополнительно можно нагрузить их логикой, чтобы хоть как то оправдать их существование.

> НИКОГДА не используйте комплексные компоненты!
> Для маршрутизации страниц существует роутер (urlrewrite.php).
> Выделяйте конкретный функционал в конкретную страницу или сервис.

## Структура

Список файлов:
- .parameters.php
- .description.php
- class.php
- component.php (устарело)
- lang
  - папка языковых файлов
- templates
  - папки шаблонов
 
### .parameters.php 
Файл содержит описание входных параметров компонента для визуального редактора. [Подробнее](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=43&LESSON_ID=2132&LESSON_PATH=3913.4565.2132).  

### .description.php
Файл содержит название, описание компонента и его положение в дереве логического размещения для визуального редактора.

### class.php
Файл содержит реализацию класса компонента. [Подробнее](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=43&LESSON_ID=2828&LESSON_PATH=3913.4565.2828).  

### component.php
Файл содержит реализацию логики компонента (по сути содержимое метода *executeComponent*). Использовать не стоит, т.к. процедурный стиль днище и он крайне не структурирован.

[Пример реализации](https://github.com/irpsv/bitrix-module/tree/master/src/components/test-comp).

## Логика работы

Порядок работы:
1. Точка входа: `CBitrixComponent::executeComponent`, именно с данного метода начинается выполнение компонента.
2. Если компонента подключает шаблон - шаг 3. Иначе - выход.
3. Подключение файла шаблона **result_modifier.php**
4. Подключение файла шаблона **template.php**
5. Подключение файла шаблона **component_epilog.php**

При кешировании результатов компонента (метод `CBitrixComponent::startResultCache`), шаги 3-4 не выполняются.

## Параметры

Каждый компонент имеет ряд стандартных параметров:
- CACHE_TIME - время кеширования (в секундах)
- CACHE_TYPE - тип кеша (A,Y,N)

## Шаблоны

При реализации шаблонов для компонентов, вся информация должна выводиться на подготовленных компонентом данных `$arResult`, параметры компонента `$arParams` должны использоваться только для настройки отображения (например, "формат даты и времени", "флаг отображения картинки", ...).  
Исключением служат компоненты, которые не имеют подготовленных данных (отсутствует `arResult`).  
Это могут быть компоненты, которые только отображают информацию определенным образом.  
В шаблоне компонента, желательно использовать методологию [БЭМ](https://ru.bem.info), как минимум наименования классов.  
Наименования класса главного блока (т.е. блока, который оборачивает в себя весь шаблон), должно напрямую формироваться из названия компонента и названия шаблона.  
Например, для компонента `vendor:item.view` и шаблона `product-cart`, главный класс может быть вида `vendor-item-view vendor-item-view_product-cart`. 

## Структура шаблонов компонентов

Список файлов:
- .description.php
- .parameters.php
- result_modifier.php
- component_epilog.php
- style.css
- script.js
- lang
  - папка языковых файлов
- assets
  - остальные файлы шаблона

### .parameters.php
Файл содержит описание дополнительных параметров шаблона для визуального редактора.  

### .description.php
Файл содержит название, описание шаблона для визуального редактора.  

## result_modifier.php
Файл содержит логику пред-обработки данных шаблона (кешируется).
В данном файлу нужно реализовывать всю обработку данных, чтобы в **template.php** просто обращаться к элементам массива.  

### component_epilog.php
Файл содержит логику пост-обработки данных шаблона (не кешируется).
В данном файле нужно размещать все манипуляции с состоянием (например, вызовы APPLICATION, подключение сторонних стилей/скриптов, ...).
Желательно НЕ использовать в данном файле переменные `$arResult`, `$arParams` и др. контекстные переменные, доступные в файлах **template.php** и **result_modifier.php** (см. далее про дочерние компоненты).

### style.css
Файл содержит CSS стили шаблона.  

### script.js
Файл содержит JS скрипты шаблона.  
Также в папке шаблона, допустимо размещать и другие файлы, необходимые для самого шаблона. Однако лучше размешать их в отдельной папке **assets**.

[Пример реализации](https://github.com/irpsv/bitrix-module/tree/master/src/components/test-comp/templates/.default).

## Дочерние компоненты

Любой компонент, может вызывать любые компоненты (даже вкладываться в самого себя), сколько угодно раз.
Для того чтобы корректно отрабатывало кеширование компонентов, при внутреннем вызове компонента, нужно указывать текущий компонент.
В файле любого шаблона **template.php** доступна переменная `$component`, которую нужно указать при вызове дочернего компонента:
```php
$APPLICATION->IncludeComponent("component_name", "template_name", ["..."], $component);
```

### component_epilog.php

При кешировании родительского компонента, все файлы **component_epilog.php** дочерних компонентов будут вызываться в порядке вызова БЕЗ кеширования.
Однако, переменные `$arResult`, `$arParams`, `$component`, `$this` будут указывать на переменные **родительского** компонента!
Так как запретить кеширование родительского компонента из дочернего не представляется возможным (и технически, и с точки зрения логики), то использовать контекстные переменные **не стоит**.

## AJAX

Ебаный пиздец, все что можно сказать.
Сложно, криво и непонятно.
Не стоит использовать.
Если нужная какая-либо логика обработки, или ленивая загрузку компонента - все это должно осуществлятся по средствам вызова отдельного сервиса, который в свою очередь уже может подключать нужный компонент.

## Рекомендации

Список рекомендаций, который **очень желательно** соблюдать при работе с компонентами.
Данный список основывается на принципах ООП и на собственном опыте:
1. компонент может либо выводить данные, либо возвращать их. Одновременно это делать **нельзя**.
1. компонент **должен** оперировать, как можно меньшими (по размерам) данными. Т.е. если выводится список элементов инфоблока, то компонент должен отправлять в `$arResult`, только идентификаторы элементов. В последствии **шаблон**, сам выгрузит нужные данные из базы. Делать это необходимо, чтобы кешировался максимально голый HTML, а файлы кеша были минимальными.
1. все константы и переменные компонента, должны использоваться только внутри компонента (классы, шаблон и др. файлы компонента).
1. компонент **не может** принимать данные по ссылке и производить их модификацию. Это должны делать хелперы или другие классы бизнес-логики.
1. компонент **должен** основываться только на полученных параметрах. *Например, у нас есть компонент, который выводит закладки пользователя, хранящиеся в инфоблоке. В классе компонента не должен прописываться ID инфоблока (или любая другая информацию об ИБ). Вся информация должна поступать в параметрах компонента. Также можно использовать глобальную конфигурацию модуля. Ссылки на страницы и сервисы, также должны находиться в параметрах, а не в шаблоне (и тем более не в классе)*.
1. шаблон компонента **может** содержать специфическую для сайта информацию (URL адреса страниц, сервисов, включаемые области, ...). Компонент **не может** использовать данную информацию (см. пункт выше).
1. компонент **может** иметь сквозные параметры, которые не используются в классе компонента и не влияют на логику, а используются в шаблоне и влияют на внешний вид. Собственно от шаблона к шаблону, эти параметры могут меняться.
1. компонент **не может** редактировать параметры. Все результаты работы компонента должны записываться в `$arResult`.
